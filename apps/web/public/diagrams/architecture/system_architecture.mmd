---
config:
  layout: elk
---
flowchart TB
 subgraph subGraph0["Client Layer"]
        WebApp["Next.js Web App<br>(React 19, Tailwind)"]
        AdminPortal["Admin Portal<br>(admin.domain.com)"]
  end
 subgraph subGraph1["API Layer"]
        tRPC["tRPC Server<br>(Type-safe API)"]
        Middleware["Middleware<br>(Auth, Rate Limit, Subdomain)"]
        APIRoutes["API Routes<br>(/api/*)"]
  end
 subgraph subGraph2["Service Layer"]
        AuthService["Better Auth<br>(Email/Password)"]
        ChatRouter["Chat Router<br>(Message Handling)"]
        ChatbotRouter["Chatbot Router<br>(CRUD Operations)"]
        FileRouter["File Router<br>(Upload/Process)"]
        AdminRouter["Admin Router<br>(User Approval)"]
        AnalyticsRouter["Analytics Router<br>(Usage Stats)"]
  end
 subgraph subGraph3["AI/RAG Layer"]
        OpenRouter["OpenRouter Client<br>(LLM Inference)"]
        RAGService["RAG Service<br>(Document Processing)"]
        EmbeddingGen["Embedding Generator<br>(OpenAI text-embedding-3-small)"]
  end
 subgraph subGraph4["Data Layer"]
        PostgreSQL["PostgreSQL<br>(Supabase + pgvector)"]
        Storage["Supabase Storage<br>(File Storage)"]
        Redis["Upstash Redis<br>(Rate Limiting)"]
  end
 subgraph subGraph5["Background Jobs"]
        QStash["Upstash QStash<br>(Job Queue)"]
        FileProcessor["File Processor<br>(Async Processing)"]
  end
 subgraph subGraph6["External Services"]
        Models["AI Models<br>(Llama 3.3, Mistral,<br>Qwen, GPT-OSS)"]
        OpenAI["OpenAI API<br>(text-embedding-3-small)"]
        Resend["Resend<br>(Email Notifications)"]
  end
 subgraph subGraph7["Database Schema"]
        Users["users<br>(Auth, Status, Role)"]
        Chatbots["chatbots<br>(Config, Prompts)"]
        Files["chatbot_files<br>(Metadata, Status)"]
        Chunks["file_chunks<br>(Text + Embeddings)"]
        Conversations["conversations<br>(Sessions)"]
        Messages["messages<br>(Chat History)"]
        Analytics["analytics<br>(Events, Metrics)"]
  end
    WebApp --> Middleware
    AdminPortal --> Middleware
    Middleware --> tRPC & Redis
    tRPC --> AuthService & ChatRouter & ChatbotRouter & FileRouter & AdminRouter & AnalyticsRouter
    ChatRouter --> EmbeddingGen & OpenRouter & PostgreSQL
    FileRouter --> Storage & QStash & PostgreSQL
    AdminRouter --> Resend & PostgreSQL
    QStash --> FileProcessor
    FileProcessor --> RAGService & Storage & PostgreSQL
    RAGService --> EmbeddingGen
    OpenRouter --> Models
    Models --> OpenRouter
    EmbeddingGen --> OpenAI
    OpenAI --> EmbeddingGen
    ChatbotRouter --> PostgreSQL
    AnalyticsRouter --> PostgreSQL
    AuthService --> PostgreSQL
    PostgreSQL -.-> Users & Chatbots & Files & Chunks & Conversations & Messages & Analytics
    APIRoutes --> tRPC
